# Use a minimal base image for Rust and FoundationDB
FROM ubuntu:20.04

# Install dependencies
RUN apt-get update && apt-get install -y \
    curl \
    wget \
    build-essential \
    rustc \
    cargo \
    libssl-dev \
    pkg-config \
    libclang-dev \
    libz-dev \
    ca-certificates \
    libc6-dev \
    git \
    unzip \
    && rm -rf /var/lib/apt/lists/*

# Install FoundationDB client and server
RUN wget https://github.com/apple/foundationdb/releases/download/7.1.15/foundationdb-clients_7.1.15-1_amd64.deb && \
    wget https://github.com/apple/foundationdb/releases/download/7.1.15/foundationdb-server_7.1.15-1_amd64.deb && \
    dpkg -i foundationdb-clients_7.1.15-1_amd64.deb && \
    dpkg -i foundationdb-server_7.1.15-1_amd64.deb && \
    apt-get install -f -y && \
    rm -f foundationdb-clients_7.1.15-1_amd64.deb foundationdb-server_7.1.15-1_amd64.deb

# Start FoundationDB and mvstore server
RUN systemctl enable foundationdb

# Download and install mvstore binary
RUN curl -L -o /usr/local/bin/mvstore https://github.com/losfair/mvsqlite/releases/download/v0.2.1/mvstore && \
    chmod +x /usr/local/bin/mvstore

# Download the mvSQLite preload library
RUN curl -L -o /usr/local/lib/libmvsqlite_preload.so https://github.com/losfair/mvsqlite/releases/download/v0.2.1/libmvsqlite_preload.so

# Expose necessary ports (data plane and admin API)
EXPOSE 7000 7001

# Set environment variables for mvstore
ENV MVSQLITE_DATA_PLANE="http://localhost:7000"

# Start FoundationDB and mvstore
CMD systemctl start foundationdb && \
    RUST_LOG=info /usr/local/bin/mvstore \
      --data-plane 127.0.0.1:7000 \
      --admin-api 127.0.0.1:7001 \
      --metadata-prefix mvstore \
      --raw-data-prefix m